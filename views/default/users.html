{{extend 'layout.html'}}

  {{
  def is_following(follower, followee):
    if db((db.follows.follower == follower) & (db.follows.followee == followee)).count():
      return True
    else:
      return False
  pass

  def follow_url(follower, followee):
    return URL('default', 'follow')

  pass
  }}

<!--<body onload="checkList()">-->
<h1>{{=name}}</h1>
<!-- TODO change this -->
{{ if auth.user is not None and str(auth.user.id) != request.args[0]: }}
  <button id="btn-unfollow" class="hidden" onclick="unfollow()">Unfollow</button>
  <button id="btn-follow" onclick="follow()">Follow</button>
{{ pass }}
<div id ="main_body" name="main_body" title="etc etc"> 
  <div id="prof_pic" name="prof_pic" title="Profile Picture">
    <img src = {{=URL('default', 'download', args=picture )}} style="width:341px;height:256px;" />
  </div>
  <div id="profile_description" name="profile_description" title="Profile Description">
    <p><h3>Description</h3></p>
    <p>Gender: {{=gender}}</p>
    <p>Experance: {{=experance}}</p>
    <p>description: {{=description}}</p>
  </div>
</div>
<h3>Itineraries</h3>
<!--<script type="text/javascript">
  function checkList()
  {
    ajax('{{=URL('default','updateItOnView')}}', ['blank'], ':eval');
    return false;
  }-->
</script>
<div id="iter_body" name="iter_body" title="body for iter">
<div id = "target">
{{for it in its:}}
{{if it.ownerA == user.id:}}
{{=LI(A(it.it_name, _href=URL(c="default",f="showIts", args=[it.it_name,it.des_location,it.days_staying_start,it.days_staying_end,it.description_of_stays])))}}
{{pass}}
{{pass}}
</div>
<div id = "blank"></div>
<form id = 'itForm'>
  <h3>Itinerary Name? </h3> 
  <input type = "text" id = "d_name" name = "d_name" ></input><br>
  <h3>Location Staying? </h3>
  <input type = "text" id = "d_location"  name = "d_location" ></input><br>
  <h3>Trip starts? (format yr-month-date ex. 2016-03-04)</h3>
  <input type = "date" id = "d_start_date" name = "d_start_date"></input><br>
  <h3>Trip ends? (format yr-month-date ex. 2016-03-04)</h3>
  <input tpye = "date" id = "d_end_date" name = "d_end_date"></input><br>
  <h3>Few words or comments about this trip?</h3> 
  <input type = "text" id = "d_description" name = "d_description"></input><br>
  <input type = "button" id = "toSub" value = "Submit" onclick="callAjax()" />
</form>
</div>
<script>

/*
  function validate()
  {
    if( jQuery("#d_name").val().length       > 0  &&
     jQuery("#d_location").val().length      > 0  && 
     jQuery("#d_start_date").val().length    > 0  && 
     jQuery("#d_end_date").val().length      > 0  && 
     jQuery("#d_description").val().length   > 0  )
      jQuery("#toSub").prop("disabled", false)
    else
      jQuery("#toSub").prop("disabled", true)

  }

  jQuery("#d_start_date").focusout(function()
  {
    var checkMe     = jQuery("#d_start_date").val();
    var regExToTest = /(\d\d\d\d)-([0][1-9]|[1][0-2])-([0][1-9]|[1][0-2])/g;
    var results     = regExToTest.test(checkMe);
    if( !results )
     alert("Not the proper date format");
  });

  jQuery("#d_end_date").focusout(function()
  {
    var checkMe     = jQuery("#d_end_date").val();
    var regExToTest = /(\d\d\d\d)-([0][1-9]|[1][0-2])-([0][1-9]|[1][0-2])/g;
    var results     = regExToTest.test(checkMe);
    if( !results )
     alert("Not the proper date format");
  });
*/
  function checkProperDate(check, checkMe)
  {
        if(check) 
        {
          var month = checkMe.substring(0,2);
          var day   = checkMe.substring(3,5);
          var year  = checkMe.substring(6,checkMe.length);
          var dayInt     = parseInt(day);
          var monthInt   = parseInt(month);
          var yearInt    = parseInt(year)
          var leapCheck  = false;
          var leapResult = -1;

/*          alert(dayInt);
          alert(monthInt);
          alert(yearInt);
          alert(typeof dayInt);*/

          if(monthInt < 1 || monthInt > 12)
            return false;
          if(dayInt < 1 || dayInt > 31)
            return false;
          if(monthInt == 2)
          {
            leapResult = yearInt % 4;
            if(leapResult != 0)
              if(dayInt > 29)
                return false;
          }
          if(yearInt < 1930 || yearInt > 2100)
            return false
          return true;
        }
        else
          return false;
  }

  function callAjax()
  {
    var nameCheck  = false;
    var locCheck   = false;
    var startCheck = true;
    var endCheck   = true;
    var decCheck   = false;
    var checkMeDateStart      = jQuery("#d_start_date").val();
    var checkProperFormStart  = /(\d\d)-(\d\d)-(\d\d\d\d)/g;
    var formCheckResultsStart = checkProperFormStart.test(checkMeDateStart);
    var checkMeDateEnd        = jQuery("#d_end_date").val();
    var checkProperFormEnd    = /(\d\d)-(\d\d)-(\d\d\d\d)/g;
    var formCheckResultsEnd   = checkProperFormEnd.test(checkMeDateEnd);

    if(jQuery("#d_name").val().length > 0)
      nameCheck = true;
    if(jQuery("#d_location").val().length > 0)
      locCheck = true;
    if(jQuery("#d_description").val().length > 0)  
      decCheck=true;

    startCheck = checkProperDate(formCheckResultsStart, checkMeDateStart);
    endCheck   = checkProperDate(formCheckResultsEnd, checkMeDateEnd);

    alert(startCheck);
    alert(endCheck);

    if( nameCheck && locCheck && startCheck && endCheck && decCheck )
    {
      ajax('{{=URL('default','doStuff')}}', ['d_name','d_location', 'd_start_date', 'd_end_date', 'd_description'], ':eval');
      return false;
    }
    else
    {
      alert("Fields are not properly inputed");
      return false;
    }
  }
</script>
</div>


<h3>Followers</h3>
<ul id="followers-list">
{{for f in followers:}}
  <li {{ if auth.user is not None and f.follower.id == auth.user.id: }} id="follower-me" {{ pass }}>
    <a href="{{=f.follower.id}}">{{=f.follower.first_name}} {{=f.follower.last_name}}</a>
  </li>
  {{pass}}
</ul>
  <h3>Following</h3>
  <ul id="following-list">
  {{for f in following:}}
  <li><a href="{{=f.followee.id}}">{{=f.followee.first_name}} {{=f.followee.last_name}}</a></li>
  {{pass}}
  </ul>

  <!--{{ block page_js }}-->
  {{ if auth.user is not None and str(auth.user.id) != request.args[0]: }}

  <script type="text/javascript">
    var following = 'True' == '{{=is_following(auth.user.id, request.args[0])}}';

    var btn_unfollow = $("#btn-unfollow");
    var btn_follow = $("#btn-follow");

    function toggle_buttons() {
      btn_follow.toggleClass("hidden");
      btn_unfollow.toggleClass("hidden");
    }

    if (following) {
      toggle_buttons();
    }

    function unfollow() {
      follow_submit("unfollow", function() {toggle_buttons(); $('#follower-me').remove();});
    }

    function follow() {
      function successful_follow() {
        toggle_buttons();
        var li = "<li id='follower-me'><a href='{{=auth.user.id}}'>{{=auth.user.first_name}} {{=auth.user.last_name}}</a></li>";
        $("#followers-list").prepend(li);
      }
      follow_submit("follow", successful_follow());
    }

    function follow_submit(action, success_action) {
    $.ajax({
      url: "{{=follow_url(auth.user.id, request.args[0])}}",
      method: "POST",
      dataType: "text",
      data: { action : action, user : {{=request.args[0]}} },
      success: success_action,
      error: function (a, b, c) {
        alert(c);
      }
    })
    };
  </script>
  {{ pass }}
  {{ end page_js }}
  <!--</body>-->
